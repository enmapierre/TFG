---
import Layout from '../layouts/Main.astro';
---

<Layout title="Finalizar Compra - Sara's Jewels">
  <main class="bg-gray-50 py-8 min-h-screen">
    <div class="mx-auto px-4 max-w-6xl">
      <div class="mb-8 text-center">
        <h1 class="mb-2 font-bold text-gray-900 text-3xl">Finalizar Compra</h1>
        <p class="text-gray-600">Completa tu pedido de forma segura</p>
      </div>

      <div class="gap-8 grid grid-cols-1 lg:grid-cols-2">
        <!-- Aquí sigue tu formulario completo, que no he tocado -->
        <div class="bg-white shadow-sm p-6 rounded-lg">
          <h2 class="mb-6 font-semibold text-gray-900 text-xl">Información de Envío</h2>
          
          <form id="checkout-form" class="space-y-4">
            <!-- Información Personal -->
            <div class="gap-4 grid grid-cols-1 md:grid-cols-2">
              <div>
                <label for="name" class="block mb-1 font-medium text-gray-700 text-sm">Nombre *</label>
                <input 
                  type="text" 
                  id="name"
                  name="name" 
                  required 
                  class="px-3 py-2 border border-gray-300 focus:border-transparent rounded-md focus:outline-none focus:ring-2 focus:ring-gray-800 w-full"
                  placeholder="Tu nombre"
                />
              </div>
              <div>
                <label for="surname" class="block mb-1 font-medium text-gray-700 text-sm">Apellidos *</label>
                <input 
                  type="text" 
                  id="surname"
                  name="surname" 
                  required 
                  class="px-3 py-2 border border-gray-300 focus:border-transparent rounded-md focus:outline-none focus:ring-2 focus:ring-gray-800 w-full"
                  placeholder="Tus apellidos"
                />
              </div>
            </div>

            <div>
              <label for="email" class="block mb-1 font-medium text-gray-700 text-sm">Email *</label>
              <input 
                type="email" 
                id="email"
                name="email" 
                required 
                class="px-3 py-2 border border-gray-300 focus:border-transparent rounded-md focus:outline-none focus:ring-2 focus:ring-gray-800 w-full"
                placeholder="tu@email.com"
              />
            </div>

            <div>
              <label for="phone" class="block mb-1 font-medium text-gray-700 text-sm">Teléfono</label>
              <input 
                type="tel" 
                id="phone"
                name="phone" 
                class="px-3 py-2 border border-gray-300 focus:border-transparent rounded-md focus:outline-none focus:ring-2 focus:ring-gray-800 w-full"
                placeholder="+34 600 000 000"
              />
            </div>

            <!-- Dirección de Envío -->
            <div class="pt-4 border-t">
              <h3 class="mb-4 font-medium text-gray-900 text-lg">Dirección de Envío</h3>
              
              <div>
                <label for="address" class="block mb-1 font-medium text-gray-700 text-sm">Dirección *</label>
                <input 
                  type="text" 
                  id="address"
                  name="address" 
                  required 
                  class="px-3 py-2 border border-gray-300 focus:border-transparent rounded-md focus:outline-none focus:ring-2 focus:ring-gray-800 w-full"
                  placeholder="Calle, número, piso"
                />
              </div>

              <div class="gap-4 grid grid-cols-1 md:grid-cols-3 mt-4">
                <div>
                  <label for="city" class="block mb-1 font-medium text-gray-700 text-sm">Ciudad *</label>
                  <input 
                    type="text" 
                    id="city"
                    name="city" 
                    required 
                    class="px-3 py-2 border border-gray-300 focus:border-transparent rounded-md focus:outline-none focus:ring-2 focus:ring-gray-800 w-full"
                    placeholder="Madrid"
                  />
                </div>
                <div>
                  <label for="postal_code" class="block mb-1 font-medium text-gray-700 text-sm">C.P. *</label>
                  <input 
                    type="text" 
                    id="postal_code"
                    name="postal_code" 
                    required 
                    class="px-3 py-2 border border-gray-300 focus:border-transparent rounded-md focus:outline-none focus:ring-2 focus:ring-gray-800 w-full"
                    placeholder="28001"
                  />
                </div>
                <div>
                  <label for="country" class="block mb-1 font-medium text-gray-700 text-sm">País *</label>
                  <select 
                    id="country"
                    name="country" 
                    required 
                    class="px-3 py-2 border border-gray-300 focus:border-transparent rounded-md focus:outline-none focus:ring-2 focus:ring-gray-800 w-full"
                  >
                    <option value="ES">España</option>
                    <option value="PT">Portugal</option>
                    <option value="FR">Francia</option>
                    <option value="IT">Italia</option>
                    <option value="DE">Alemania</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Información de Pago -->
            <div class="pt-6 border-t">
              <h3 class="mb-4 font-medium text-gray-900 text-lg">Información de Pago</h3>
              
              <div>
                <label for="card_number" class="block mb-1 font-medium text-gray-700 text-sm">Número de Tarjeta *</label>
                <input 
                  type="text" 
                  id="card_number"
                  name="card_number" 
                  required 
                  maxlength="19"
                  class="px-3 py-2 border border-gray-300 focus:border-transparent rounded-md focus:outline-none focus:ring-2 focus:ring-gray-800 w-full"
                  placeholder="1234 5678 9012 3456"
                />
              </div>

              <div class="gap-4 grid grid-cols-2 mt-4">
                <div>
                  <label for="card_expiry" class="block mb-1 font-medium text-gray-700 text-sm">Fecha de Vencimiento *</label>
                  <input 
                    type="text" 
                    id="card_expiry"
                    name="card_expiry" 
                    required 
                    maxlength="5"
                    class="px-3 py-2 border border-gray-300 focus:border-transparent rounded-md focus:outline-none focus:ring-2 focus:ring-gray-800 w-full"
                    placeholder="MM/YY"
                  />
                </div>
                <div>
                  <label for="card_cvc" class="block mb-1 font-medium text-gray-700 text-sm">CVC *</label>
                  <input 
                    type="text" 
                    id="card_cvc"
                    name="card_cvc" 
                    required 
                    maxlength="4"
                    class="px-3 py-2 border border-gray-300 focus:border-transparent rounded-md focus:outline-none focus:ring-2 focus:ring-gray-800 w-full"
                    placeholder="123"
                  />
                </div>
              </div>

              <div class="mt-4">
                <label for="card_name" class="block mb-1 font-medium text-gray-700 text-sm">Nombre en la Tarjeta *</label>
                <input 
                  type="text" 
                  id="card_name"
                  name="card_name" 
                  required 
                  class="px-3 py-2 border border-gray-300 focus:border-transparent rounded-md focus:outline-none focus:ring-2 focus:ring-gray-800 w-full"
                  placeholder="Nombre como aparece en la tarjeta"
                />
              </div>
            </div>

            <!-- Términos y Condiciones -->
            <div class="pt-4 border-t">
              <label class="flex items-start space-x-3">
                <input 
                  type="checkbox" 
                  id="terms"
                  name="terms" 
                  required 
                  class="mt-1 border-gray-300 rounded focus:ring-gray-800 w-4 h-4 text-gray-800"
                />
                <span class="text-gray-600 text-sm">
                  Acepto los <a href="/terms" class="text-gray-800 underline">términos y condiciones</a> 
                  y la <a href="/privacy" class="text-gray-800 underline">política de privacidad</a>
                </span>
              </label>
            </div>

            <!-- Mensaje de Estado -->
            <div id="checkout-message" class="hidden p-3 rounded-md font-medium text-sm"></div>

            <!-- Botón de Envío -->
            <button 
              type="submit" 
              id="submit-button"
              class="bg-gray-800 hover:bg-gray-700 disabled:opacity-50 px-4 py-3 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-800 focus:ring-offset-2 w-full font-medium text-white transition-colors disabled:cursor-not-allowed"
            >
              <span class="submit-text">Completar Pedido</span>
              <span class="hidden loading-spinner">
                <svg class="inline mr-3 -ml-1 w-5 h-5 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Procesando...
              </span>
            </button>
          </form>
        </div>
        <!-- Resumen del Pedido -->
         <script>
          // Obtenemos y parseamos el carrito de forma segura
          const cartRaw = localStorage.getItem("cart");
          const cart = cartRaw ? JSON.parse(cartRaw) : [];

          // Referencias a los elementos del DOM
          const cartItemsContainer = document.getElementById("cart-items");
          const emptyCartMessage = document.getElementById("empty-cart-message");

          // Si hay productos, mostramos el contenedor y los productos
          if (cart.length > 0) {
            cartItemsContainer.classList.remove("hidden");
            emptyCartMessage.classList.add("hidden");

            cart.forEach((item) => {
              const productHTML = `
                <div class="flex gap-4 pb-4 border-b">
                  <img src="${item.image}" alt="${item.title}" class="rounded w-20 h-20 object-cover" />
                  <div>
                    <h3 class="font-semibold">${item.title}</h3>
                    <p class="text-gray-600 text-sm">${item.description}</p>
                    <p class="text-sm">Cantidad: ${item.quantity}</p>
                    <p class="font-medium text-sm">Precio: €${item.price}</p>
                  </div>
                </div>
              `;
              cartItemsContainer.innerHTML += productHTML;
            });
          } else {
            // Si no hay productos, aseguramos que el mensaje se muestre
            cartItemsContainer.classList.add("hidden");
            emptyCartMessage.classList.remove("hidden");
          }
        </script>

        <div class="top-8 sticky bg-white shadow-sm p-6 rounded-lg h-fit">
          <h2 class="mb-6 font-semibold text-gray-900 text-xl">Resumen del Pedido</h2>

          <!-- Contenedor de resumen de carrito -->
          <div id="cart-summary">
            <div id="empty-cart-message" class="py-10 text-center">
  <svg class="mx-auto mb-4 w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path d="M3 3h2l.4 2M7 13h10l4-8H5.4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <circle cx="9" cy="21" r="1" />
    <circle cx="20" cy="21" r="1" />
  </svg>
  <p class="text-gray-500">Tu carrito está vacío</p>
  <a href="/tienda" class="text-blue-600 hover:underline">Continuar Comprando</a>
</div>

            <div id="cart-items" class="hidden space-y-4"></div>
           <script>
  const cartRaw = localStorage.getItem("cart");
  const cart = cartRaw ? JSON.parse(cartRaw) : [];
  console.log("Productos del carrito:", cart);
</script>
          </div>

          <!-- Costos -->
          <div id="cost-summary" class="hidden">
            <div class="mt-6 pt-4 border-t">
              <div class="flex justify-between mb-2 text-gray-600 text-sm">
                <span>Subtotal</span>
                <span id="subtotal">€0.00</span>
              </div>
              <div class="flex justify-between mb-2 text-gray-600 text-sm">
                <span>Envío</span>
                <span id="shipping">Gratis</span>
              </div>
              <div class="flex justify-between mb-4 text-gray-600 text-sm">
                <span>IVA (21%)</span>
                <span id="tax">€0.00</span>
              </div>
              <div class="flex justify-between pt-4 border-t font-semibold text-gray-900 text-lg">
                <span>Total</span>
                <span id="total">€0.00</span>
              </div>
            </div>
          </div>

          <!-- Garantías -->
          <div class="mt-6 pt-6 border-t">
            <div class="space-y-3 text-gray-600 text-sm">
              <div class="flex items-center space-x-3">
                <svg class="w-5 h-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Pago 100% seguro</span>
              </div>
              <div class="flex items-center space-x-3">
                <svg class="w-5 h-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Envío gratuito en pedidos >50€</span>
              </div>
              <div class="flex items-center space-x-3">
                <svg class="w-5 h-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Devoluciones gratuitas 30 días</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <script>
document.addEventListener("astro:page-load", initCartUI);
document.addEventListener("DOMContentLoaded", initCartUI);

function initCartUI() {
  setTimeout(() => {
    renderCartSummary();
    setupFormHandlers();
    setupCardFormatting();
  }, 200);
}

function getCartItems() {
  try {
    const saved = localStorage.getItem("cart");
    return saved ? JSON.parse(saved) : [];
  } catch {
    return [];
  }
}

function renderCartSummary() {
  const cart = getCartItems();
  const emptyMsg = document.getElementById("empty-cart-message");
  const itemsContainer = document.getElementById("cart-items");
  const costSummary = document.getElementById("cost-summary");
  const submitButton = document.getElementById("submit-button");

  if (!cart.length) {
    emptyMsg?.classList.remove("hidden");
    itemsContainer?.classList.add("hidden");
    costSummary?.classList.add("hidden");
    if (submitButton) submitButton.disabled = true;
    return;
  }

  // Mostrar items
  const html = cart.map(({ title, image, price, quantity }) => `
    <div class="flex items-center gap-4 bg-gray-50 p-4 border rounded-lg">
      <img src="${image}" alt="${title}" class="border rounded w-20 h-20 object-cover" />
      <div class="flex flex-col">
        <span class="font-medium">${title}</span>
        <span class="text-gray-600 text-sm">Cantidad: ${quantity}</span>
        <span class="text-gray-600 text-sm">Precio: €${price.toFixed(2)}</span>
        <span class="font-semibold text-gray-900 text-sm">Subtotal: €${(price * quantity).toFixed(2)}</span>
      </div>
    </div>
  `).join("");

  itemsContainer.innerHTML = html;
  emptyMsg?.classList.add("hidden");
  itemsContainer?.classList.remove("hidden");
  costSummary?.classList.remove("hidden");
  if (submitButton) submitButton.disabled = false;

  // Resumen de costes
  const subtotal = cart.reduce((sum, i) => sum + i.price * i.quantity, 0);
  const tax = subtotal * 0.21;
  const shipping = subtotal >= 50 ? 0 : 5.99;
  const total = subtotal + tax + shipping;

  document.getElementById("subtotal").textContent = `€${subtotal.toFixed(2)}`;
  document.getElementById("tax").textContent = `€${tax.toFixed(2)}`;
  document.getElementById("shipping").textContent = shipping === 0 ? "Gratis" : `€${shipping.toFixed(2)}`;
  document.getElementById("total").textContent = `€${total.toFixed(2)}`;
}

// Manejo del form de checkout
function setupFormHandlers() {
  const form = document.getElementById("checkout-form");
  if (!form) return;

  const message = document.getElementById("checkout-message");
  const submitBtn = document.getElementById("submit-button");
  const submitText = document.querySelector(".submit-text");
  const spinner = document.querySelector(".loading-spinner");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    console.log('=== INICIANDO ENVÍO DE FORMULARIO ===');
    
    if (submitBtn) submitBtn.disabled = true;
    if (submitText) submitText.classList.add("hidden");
    if (spinner) spinner.classList.remove("hidden");
    if (message) message.classList.add("hidden");

    const formData = new FormData(form);
    const cart = getCartItems();

    console.log('Carrito obtenido:', cart);

    if (!cart.length) {
      showMessage("error", "❌ Tu carrito está vacío.");
      resetSubmit();
      return;
    }

    // Validar datos de tarjeta antes de enviar
    const cardNumber = formData.get("card_number").replace(/\s/g, "");
    const cardCVC = formData.get("card_cvc");
    const cardExpiry = formData.get("card_expiry");

    if (cardNumber !== "4111111111111111" || cardCVC !== "345" || cardExpiry !== "10/25") {
      showMessage("error", "❌ Datos de tarjeta incorrectos. Usa: 4111 1111 1111 1111, CVC: 345, Vencimiento: 10/25");
      resetSubmit();
      return;
    }

    const payload = {
      name: formData.get("name"),
      surname: formData.get("surname"),
      email: formData.get("email"),
      phone: formData.get("phone"),
      address: formData.get("address"),
      city: formData.get("city"),
      postal_code: formData.get("postal_code"),
      country: formData.get("country"),
      card_number: formData.get("card_number"),
      card_expiry: formData.get("card_expiry"),
      card_cvc: formData.get("card_cvc"),
      card_name: formData.get("card_name"),
      cart: cart.map(({ title, price, quantity, image, id }) => ({
        id, 
        name: title, 
        price: parseFloat(price), 
        quantity: parseInt(quantity), 
        image
      }))
    };

    console.log('Payload preparado:', payload);
    console.log('Payload como JSON:', JSON.stringify(payload));

    cart.map(async(producto)=>{

        const UpdatedProducto = { 
          "stock":parseInt(producto.quantity)

        }
        const res = await fetch("http://localhost:8080/productos/" + producto.id, {
        method: "PUT",
        headers: { 
          "Content-Type": "application/json",//ESTO Y ERROR CONSOLA
          "Accept": "application/json"
        },
        
        body: JSON.stringify(UpdatedProducto)
      })
      const responseText = await res.text();
      const result = JSON.parse(responseText);
       if(!res.ok || !result.success){
           showMessage("success", "✅ " + result.message);
           setTimeout(() => {
              window.location.href = "/agradecimiento";
            }, 1000);

       }else{
       showMessage("error", "❌ " + (result.message || "Error en el pedido."));
       }
      
      })
     
      localStorage.removeItem("carrito");
  });

  function showMessage(type, text) {
    if (!message) return;
    message.classList.remove("hidden");
    message.textContent = text;
    message.className = `p-3 rounded-md text-sm font-medium ${type === "success" ? "bg-green-100 text-green-800 border border-green-300" : "bg-red-100 text-red-800 border border-red-300"}`;
  }

  function resetSubmit() {
    if (submitBtn) submitBtn.disabled = false;
    if (submitText) submitText.classList.remove("hidden");
    if (spinner) spinner.classList.add("hidden");
  }
}

// Formato tarjetas
function setupCardFormatting() {
  const num = document.getElementById("card_number");
  const exp = document.getElementById("card_expiry");
  const cvc = document.getElementById("card_cvc");

  num?.addEventListener("input", e => {
    let val = e.target.value.replace(/\D/g, "").substring(0, 16);
    e.target.value = val.replace(/(.{4})/g, "$1 ").trim();
  });

  exp?.addEventListener("input", e => {
    let val = e.target.value.replace(/\D/g, "").substring(0, 4);
    if (val.length > 2) val = val.slice(0, 2) + "/" + val.slice(2);
    e.target.value = val;
  });

  cvc?.addEventListener("input", e => {
    e.target.value = e.target.value.replace(/\D/g, "").substring(0, 4);
  });
}

// Escuchar actualizaciones del carrito
window.addEventListener("storage", (e) => {
  if (e.key === "cart") renderCartSummary();
});
document.addEventListener("cartUpdated", renderCartSummary);
</script>